start transaction;
insert into engine_room.MFS_TRANSACTIONS 
with commissions as (select distinct tbl_dt, instruct_hdr_fid, instruct_hdr_type,instruct_hdr_tid,instruct_amount 
from flare_8.financial_log b 
where instruct_hdr_type='COMMISSIONING' and b.tbl_dt = yyyymmddRunDate ), 
with transactions as (select date_time, STATUS_CODE,hdr_type, instruct_from_fro_user_prf , instruct_to_fro_user_prf , instruct_hdr_type , instruct_hdr_tid ,instruct_hdr_fid, instruct_amount, msisdn_key , tbl_dt ,instruct_from_fro_id , instruct_from_bal_tot_aft ,instruct_to_accnt_hldr_msisdn ,instruct_to_accnt_hldr_id , instruct_to_bal_tot_aft , instruct_to_ifee , instruct_from_ifee , kamanja_loaded_date , engine_tx_type , instruct_from_message from
( select row_number() OVER (PARTITION BY a.instruct_hdr_tid, msisdn_key, instruct_amount, date_format(from_iso8601_timestamp(a.original_timestamp_enrich ),'%Y%m%d%H%i%s') ORDER BY a.instruct_hdr_tid DESC) rnk, date_format(from_iso8601_timestamp(a.original_timestamp_enrich ),'%Y%m%d%H%i%s') date_time , hdr_type, STATUS_CODE, instruct_from_fro_user_prf,instruct_to_fro_user_prf, instruct_hdr_type,instruct_hdr_tid,instruct_hdr_fid, instruct_amount,msisdn_key,tbl_dt, instruct_from_fro_id, instruct_from_bal_tot_aft,instruct_to_accnt_hldr_msisdn, instruct_to_accnt_hldr_id, instruct_to_bal_tot_aft, instruct_to_ifee, instruct_from_ifee, kamanja_loaded_date ,  case when instruct_hdr_type='CASH_IN' and  instruct_from_accnt_hldr_usr_prf  not in ('Special Account Holder Profile', 'Youth Account Holder Profile', 'Mass Market Account Holder Profile',  'Fully Banked Account Holder Profile', 'Semi Banked Account Holder Profile')  and hdr_type = 'RESERVATION' then 'CASH_IN' when instruct_hdr_type='CASH_OUT' and instruct_from_accnt_hldr_usr_prf not in ('Special Account Holder Profile', 'Youth Account Holder Profile', 'Mass Market Account Holder Profile', 'Fully Banked Account Holder Profile', 'Semi Banked Account Holder Profile') and hdr_type = 'RESERVATION' then 'CASH_OUT' when instruct_hdr_type in ('PAYMENT_SEND','PAYMENT' ) and instruct_to_accnt_hldr_usr_prf in ('YDFS Service Provider Profile','Star Times Service Provider Profile','Retail Agent Account Holder Profile WATU') and instruct_to_accnt_hldr_usr_name not in  ('9mobiledatabundle.sp','9mobilelogicalpin.sp','airteldatabundle.sp','airtellogicalpin.sp', 'glodatabundle.sp','glologicalpin.sp','mtnlogicalpin.sp','mtndatabundle.sp', 'mtnairtime.sp') and instruct_from_message is not null and msisdn_key <>0 and status_code='EXECUTE' and hdr_type = 'RESERVATION' then 'BILL_PAYMENT'   when instruct_hdr_type in ('PAYMENT_SEND' ) and instruct_to_accnt_hldr_usr_prf like '%WATU%' then 'BILL_PAYMENT'  when instruct_hdr_type='FLOAT_TRANSFER' and instruct_to_accnt_hldr_usr_prf not in ('Special Account Holder Profile', 'Youth Account Holder Profile', 'Mass Market Account Holder Profile', 'Fully Banked Account Holder Profile', 'Semi Banked Account Holder Profile') and hdr_type = 'RESERVATION' then 'FLOAT_CREDIT_TRANSFER'  when instruct_hdr_type='FLOAT_TRANSFER' and instruct_from_accnt_hldr_usr_prf not in ('Special Account Holder Profile', 'Youth Account Holder Profile', 'Mass Market Account Holder Profile', 'Fully Banked Account Holder Profile', 'Semi Banked Account Holder Profile') and hdr_type = 'RESERVATION' then 'FLOAT_DEBIT_TRANSFER'  when instruct_hdr_type in ('PAYMENT') and instruct_to_accnt_hldr_usr_name in ('AccessBank-External.sp') and hdr_type = 'RESERVATION' then 'ASSISTED_DEPOSITS'  when instruct_hdr_type = 'PAYMENT' and instruct_to_accnt_hldr_usr_name in ('AccessBank.sp') and hdr_type = 'RESERVATION' then 'PUSH'  when instruct_hdr_type in ('PAYMENT','TRANSFER' ) and instruct_from_accnt_hldr_usr_name in ('AccessBank-NIP.sp') and hdr_type = 'RESERVATION' then 'INWARD-NIP'  when instruct_hdr_type = 'TRANSFER' and instruct_from_accnt_hldr_usr_name in ('AccessBank.sp') and hdr_type = 'RESERVATION' then 'PULL'  when instruct_hdr_type = 'DEPOSIT' and hdr_type = 'RESERVATION' then 'DEPOSIT'  when instruct_hdr_type in ( 'ADJUSTMENT','PAYMENT','TRANSFER') and instruct_from_accnt_hldr_usr_name in ('AccessBank-External.sp') and hdr_type = 'RESERVATION' then 'ASSISTED_WITHWALS'  when instruct_hdr_type = 'TRANSFER_TO_VOUCHER' and instruct_from_accnt_hldr_usr_prf not in ('Special Account Holder Profile', 'Youth Account Holder Profile',  'Mass Market Account Holder Profile', 'Fully Banked Account Holder Profile',  'Semi Banked Account Holder Profile') and hdr_type = 'RESERVATION' then 'BULK_TOKEN_CREATION'  when instruct_hdr_type = 'PAYMENT' and instruct_to_accnt_hldr_usr_name in ('airuser.sp','buyairtime') and instruct_to_accnt_hldr_usr_prf in ('MTN Airtime Service Provider Account Holder') and hdr_type = 'RESERVATION' then 'AIRTIME_PURCHASES'  when instruct_hdr_type = 'PAYMENT' and instruct_to_accnt_hldr_usr_name in ('cisuser.sp','dyabundle') and instruct_to_accnt_hldr_usr_prf in ('YDFS Data Bundle Service Provider Account New', 'DYA Data Bundle Service Provider Account New') and hdr_type = 'RESERVATION' then 'DATA_BUNDLE_PURCHASES'  when instruct_hdr_type='CREATE_CASH_VOUCHER' and instruct_from_accnt_hldr_usr_prf not in ('Special Account Holder Profile', 'Youth Account Holder Profile', 'Mass Market Account Holder Profile', 'Fully Banked Account Holder Profile', 'Semi Banked Account Holder Profile') and hdr_type = 'RESERVATION' then 'TOKEN_GENERATE_VOUCHER'  when instruct_hdr_type='REDEEM_CASH_VOUCHER' and instruct_from_accnt_hldr_usr_prf not in ('Special Account Holder Profile', 'Youth Account Holder Profile', 'Mass Market Account Holder Profile', 'Fully Banked Account Holder Profile', 'Semi Banked Account Holder Profile') and hdr_type = 'RESERVATION' then 'TOKEN_REDEEM_VOUCHER'  when instruct_hdr_type='TRANSFER_FROM_VOUCHER' and hdr_type = 'RESERVATION' then 'BULK_TOKEN_REDEEM' when instruct_from_accnt_hldr_usr_name = 'flutter.sp' and status_code='EXECUTED' and hdr_type = 'RESERVATION' and instruct_hdr_type not in ('CUSTOM_COMMISSIONTRANSFER','COMMISSIONING', 'DEPOSIT') and instruct_to_message is not null then 'ASSISTED_WITHDRAWALS' when instruct_hdr_type = 'PAYMENT' and instruct_to_accnt_hldr_usr_name in ('airtelairtime.sp','gloairtime.sp','9mobileairtime.sp', '9mobilelogicalpin.sp','airtellogicalpin.sp','glologicalpin.sp','mtnlogicalpin.sp', 'mtnairtime.sp') and status_code='EXECUTED' and hdr_type = 'RESERVATION' Then 'AIRTIME_FOR_OTHER_TELCO' When instruct_hdr_type = 'PAYMENT' and instruct_to_accnt_hldr_usr_name in ('9mobiledatabundle.sp','airteldatabundle.sp','glodatabundle.sp', 'mtndatabundle.sp') and status_code='EXECUTED' and hdr_type = 'RESERVATION' Then 'DATA_FOR_OTHER_TELCO' else 'defaulted'||'-'|| instruct_hdr_type end engine_tx_type , instruct_from_message from flare_8.financial_log a where a.STATUS_CODE ='EXECUTED'   and instruct_hdr_fid in ( select instruct_hdr_fid 
from flare_8.financial_log where hdr_type = 'TXN' and status_code = 'COMMITTED' and tbl_dt = yyyymmddRunDate) and a.instruct_hdr_type not in ( 'COMMISSIONING') and ( (instruct_from_bal_tot_bfr <> instruct_from_bal_tot_aft) or (instruct_to_bal_tot_bfr <> instruct_to_bal_tot_aft)) and tbl_dt = yyyymmddRunDate )) 
select aa.instruct_hdr_fid transaction_id, engine_tx_type transaction_type, date_time date_key, aa.msisdn_key sender_msisdn, aa.instruct_from_fro_id sender_account_id, aa.msisdn_key sender_wallet_id, instruct_from_fro_user_prf from_profile, lower(cc.rpt_category) from_profile_category, aa.instruct_from_bal_tot_aft sender_wallet_balance, aa.instruct_to_accnt_hldr_msisdn receiver_msisdn, aa.instruct_to_accnt_hldr_id receiver_account_id, aa.instruct_to_accnt_hldr_msisdn receiver_wallet_id, instruct_to_fro_user_prf to_profile, lower(dd.rpt_category) to_profile_category, aa.instruct_to_bal_tot_aft receiver_wallet_balance, aa.instruct_amount transaction_amount, bb.instruct_amount pos_commission_received_amount, bb.instruct_amount pos_commission_paid_amount, aa.instruct_to_ifee fee_received_amount, aa.instruct_from_ifee fee_paid_amount, loa.bts_mu_site_id sender_cell_id, lob.bts_mu_site_id receiver_cell_id, kamanja_loaded_date, aa.tbl_dt from transactions aa left join commissions bb on ( aa.tbl_dt = bb.tbl_dt and aa.instruct_hdr_fid=bb.instruct_hdr_fid ) left join nigeria.mfs_profile_categories cc on (aa.instruct_from_fro_user_prf = cc.profile_description ) left join nigeria.mfs_profile_categories dd on (aa.instruct_to_fro_user_prf = dd.profile_description ) left join ( select msisdn_key ,bts_mu_site_id FROM nigeria.geography where tbl_dt = yyyymmddRunDate and aggr ='daily' AND msisdn_key <> 0) loa on ( aa.msisdn_key = loa.msisdn_key) left join ( select cast(msisdn_key as varchar) msisdn_key ,bts_mu_site_id 
FROM nigeria.geography where tbl_dt = yyyymmddRunDate and aggr ='daily' AND msisdn_key <> 0) lob on ( aa.instruct_to_accnt_hldr_msisdn = lob.msisdn_key);
commit;
