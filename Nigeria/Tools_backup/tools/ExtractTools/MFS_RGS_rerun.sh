 #!bin/bash
  DATE=$1
  /opt/presto/bin/presto --server master01003:8999 --catalog hive5 --schema flare_8 --execute "insert into flare_8.mfs_momo_rgs (select z.RGS, z.Agent_MSISDN, z.transaction_type, z.amount, z.name, z.gender, z.lga , z.state , z.region , z.major_region ,z.cluster, z.tbl_dt  from (with RGS30_Transaction as ( SELECT try_cast(substring(instruct_to_fri, 5, 13) as bigint) SUBS, instruct_to_accnt_hldr_usr_prf Transaction_Type, try_cast(instruct_from_accnt_hldr_msisdn as bigint) agentMSISDN, try_cast(instruct_amount as bigint) amount, instruct_hdr_fid link from flare_8.financial_log where tbl_dt = ${DATE} and status_code='EXECUTED' and hdr_type = 'RESERVATION' and instruct_to_accnt_hldr_usr_name in ('cisuser.sp','dyabundle','airuser.sp','buyairtime') and substr(split_part(instruct_to_fri, '@', 1),5,3)='234' and length(split_part(instruct_to_fri, '@', 1))=17 and msisdn_key <>0 union select try_cast(substr(split_part(instruct_from_message, ':', 2),1,13) as bigint) SUBS, instruct_to_accnt_hldr_usr_prf Transaction_Type, try_cast(instruct_from_accnt_hldr_msisdn as bigint) agentMSISDN, try_cast(instruct_amount as bigint) amount, instruct_hdr_fid link from flare_8.financial_log where instruct_hdr_type = 'PAYMENT' and status_code='EXECUTED' and instruct_to_accnt_hldr_usr_prf in ('YDFS Service Provider Profile','Star Times Service Provider Profile') and hdr_type = 'RESERVATION' and instruct_from_message is not null and status_code='EXECUTED' and msisdn_key <>0 and tbl_dt = ${DATE} union select try_cast(substr(split_part(instruct_from_message, ':', 2),1,13) as bigint) SUBS, instruct_to_accnt_hldr_usr_prf Transaction_Type, try_cast(instruct_from_accnt_hldr_msisdn as bigint) agentMSISDN, try_cast(instruct_amount as bigint) amount, instruct_hdr_fid link from flare_8.financial_log where instruct_hdr_type = 'PAYMENT_SEND' and status_code='EXECUTED' and instruct_to_accnt_hldr_usr_prf in ('Retail Agent Account Holder Profile WATU') and hdr_type = 'RESERVATION' and instruct_from_message is not null and status_code='EXECUTED' and msisdn_key <>0 and tbl_dt = ${DATE} union select try_cast(substr(split_part(instruct_from_message, ':', 4),1,13) as bigint) SUBS, 'Assisted Deposit' Transaction_Type, try_cast(msisdn_key as bigint) agentMSISDN, try_cast(instruct_amount as bigint) amount, instruct_hdr_fid link from flare_8.financial_log where instruct_hdr_type = 'PAYMENT' and instruct_to_accnt_hldr_usr_name in ('AccessBank-External.sp') and hdr_type = 'RESERVATION' and instruct_from_message is not null and status_code='EXECUTED' and msisdn_key <>0 and tbl_dt = ${DATE} union select try_cast(substr(split_part(instruct_to_message, ':', 2),1,13) as bigint) SUBS, 'Assisted Withdrawal' Transaction_Type, try_cast(instruct_to_accnt_hldr_msisdn as bigint) agentMSISDN, try_cast(instruct_amount as bigint) amount, instruct_hdr_fid link from flare_8.financial_log where instruct_hdr_type = 'TRANSFER' and instruct_from_accnt_hldr_usr_name in ('AccessBank-External.sp') and hdr_type = 'RESERVATION' and instruct_to_message is not null and status_code='EXECUTED' and tbl_dt = ${DATE}  union select TRY_CAST(Donor_MSISDN AS bigint) as SUBS, transaction_type Transaction_Type, try_cast(originating_agent as bigint) agentMSISDN, try_cast(token_amount as bigint) amount, transaction_number link FROM hive5.nigeria.mfs_voucher_finlog_cube WHERE tbl_dt = ${DATE} and transaction_type = 'CREATE_CASH_VOUCHER' and Donor_MSISDN is not null and status_of_transaction='EXECUTED' union select distinct(TRY_CAST(Receiver_MSISDN AS bigint)) as SUBS, transaction_type Transaction_Type, try_cast(redeem_agent_msisdn as bigint) agentMSISDN, try_cast(token_amount as bigint) amount, transaction_number link FROM hive5.nigeria.mfs_voucher_finlog_cube WHERE tbl_dt = ${DATE} and transaction_type = 'REDEEM_CASH_VOUCHER' and Receiver_MSISDN is not null and status_of_transaction='EXECUTED' ), location as ( select msisdn_key,bts_mu_site_id,cdr_cgi,sitename,state_cd,site_category,cluster,lga,old_territory,territory,state,region,major_region from flare_8.vp_dim_cellsite left join nigeria.geography on bts_mu_site_id = cdr_cgi where run_date = (select max(run_date) from flare_8.vp_dim_cellsite) and tbl_dt = ${DATE} and aggr ='daily' ), details as ( select concat(first_name,' ',last_name) Name,msisdn_key, gender, tbl_dt from nigeria.segment5b5_mon where tbl_dt = ${DATE} ), committe as (select instruct_hdr_fid from flare_8.financial_log where hdr_type = 'TXN' and status_code = 'COMMITTED' and tbl_dt = ${DATE} ) select a.SUBS RGS, a.agentMSISDN Agent_MSISDN, a.transaction_type transaction_type, a.amount amount, c.name name , c.gender gender , b.lga LGA, b.state STATE, b.region REGION, b.major_region MAJOR_REGION,cluster, ${DATE} tbl_dt from RGS30_Transaction a left join location b on a.agentMSISDN=b.msisdn_key left join details c on a.subs=c.msisdn_key left join committe d on a.link=d.instruct_hdr_fid where d.instruct_hdr_fid is not null ) z )"
 q1=/opt/presto/bin/presto --server master01003:8999 --catalog hive5 --schema flare_8 --execute "select count(*) from  flare_8.mfs_momo_rgs where tbl_dt = ${DATE}"
 q11=$(echo $q1 |  sed "s/\"//g")
 res=$(echo $q11)
if [[ $res != 0 ]]
then
  echo "Insertion finished for date: $DATE successfully"
else
  echo "Couldn't Insert the data due to Presto issue or mismatching numbers, Please rerun me! "
  exit 1
fi
