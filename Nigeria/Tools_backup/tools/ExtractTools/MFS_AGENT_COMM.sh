 #!bin/bash

DATE=$(date -d '-1 day' '+%Y%m%d')
qbase0=$(/opt/presto/bin/presto --server 10.1.197.145:8999 --catalog hive5 --schema flare_8 --execute "select count(*) from flare_8.financial_log where tbl_dt = ${DATE}")
qbase=$(echo $qbase0 |  sed "s/\"//g")

if [[ $qbase != 0 ]]
then
  /opt/presto/bin/presto --server 10.1.197.145:8999 --catalog hive5 --schema flare_8 --execute "insert into flare_8.mfs_momo_agent_commission ( select z.commission_ty_type,z.instruct_hdr_fid,z.Commission_Amount,z.Transaction_type,z.transaction_amount,z.msisdn_key,z.tbl_dt from (with one as ( SELECT instruct_hdr_fid, instruct_amount from flare_8.financial_log where tbl_dt =${DATE} and instruct_hdr_type in ('COMMISSIONING') and instruct_hdr_fid in (select instruct_hdr_fid from flare_8.financial_log where hdr_type = 'TXN' and status_code = 'COMMITTED' and tbl_dt =${DATE}) ), two as ( SELECT 'Airtime' Transaction_Type,instruct_amount,msisdn_key, instruct_hdr_fid from flare_8.financial_log where tbl_dt =${DATE} and status_code='EXECUTED' and hdr_type = 'RESERVATION' AND split_part(instruct_to_fri, '@', 2) IN ('buyairtime/SP','airuser.sp/SP') and substr(split_part(instruct_to_fri, '@', 1),5,3)='234' and length(split_part(instruct_to_fri, '@', 1))=17 and msisdn_key <>0 union SELECT 'Data' Transaction_Type, instruct_amount, msisdn_key, instruct_hdr_fid from flare_8.financial_log where tbl_dt =${DATE} and status_code='EXECUTED' and hdr_type = 'RESERVATION' AND split_part(instruct_to_fri, '@', 2) IN ('dyabundle/SP','cisuser.sp/SP') and substr(split_part(instruct_to_fri, '@', 1),5,3)='234' and length(split_part(instruct_to_fri, '@', 1))=17 and msisdn_key <>0 union select 'Bill Payment' Transaction_Type,instruct_amount, msisdn_key, instruct_hdr_fid from flare_8.financial_log where instruct_hdr_type = 'PAYMENT' and status_code='EXECUTED' and instruct_to_accnt_hldr_usr_prf in ('YDFS Service Provider Profile','Star Times Service Provider Profile', 'YELLOW PSB Billers Service Provider Profile', 'Yellow PSB Service Provider Profile', 'XAAS External Originated Transaction Profile' ) and hdr_type = 'RESERVATION' and instruct_from_message is not null and status_code='EXECUTED' and msisdn_key <>0 and tbl_dt =${DATE} union select 'Assisted Deposit' Transaction_Type,instruct_amount, msisdn_key, instruct_hdr_fid from flare_8.financial_log where instruct_hdr_type = 'PAYMENT' and instruct_to_accnt_hldr_usr_name in ('AccessBank-External.sp', 'AccessBank.sp' ) and hdr_type = 'RESERVATION' and status_code='EXECUTED' and tbl_dt =${DATE} and msisdn_key <>0 union select 'Assisted Withdrawal' Transaction_Type,instruct_amount,msisdn_key, instruct_hdr_fid from flare_8.financial_log where instruct_hdr_type = 'TRANSFER' and instruct_from_accnt_hldr_usr_name in ('AccessBank-External.sp', 'AccessBank.sp') and hdr_type = 'RESERVATION' and status_code='EXECUTED' and tbl_dt =${DATE} and msisdn_key <>0 union select 'Create Cash Voucher' Transaction_Type,instruct_amount,msisdn_key, instruct_hdr_fid from flare_8.financial_log where instruct_hdr_type = 'CREATE_CASH_VOUCHER' and hdr_type = 'RESERVATION' and status_code='EXECUTED' and tbl_dt =${DATE} and msisdn_key <>0 union select 'Redeem Cash Voucher' Transaction_Type,instruct_amount,msisdn_key, instruct_hdr_fid from flare_8.financial_log where instruct_hdr_type = 'REDEEM_CASH_VOUCHER' and hdr_type = 'RESERVATION' and status_code='EXECUTED' and tbl_dt =${DATE} and msisdn_key <>0 UNION SELECT 'Transfer From Voucher' Transaction_Type, instruct_amount,msisdn_key,instruct_hdr_fid from flare_8.financial_log where tbl_dt =${DATE} and status_code='EXECUTED' and hdr_type = 'RESERVATION' AND instruct_hdr_type = 'TRANSFER_FROM_VOUCHER' and msisdn_key <>0 UNION SELECT 'Transfer To Voucher' Transaction_Type, instruct_amount,msisdn_key,instruct_hdr_fid from flare_8.financial_log where tbl_dt =${DATE} and status_code='EXECUTED' and hdr_type = 'RESERVATION' AND instruct_hdr_type = 'TRANSFER_TO_VOUCHER' and msisdn_key <>0 ) select 'COMMISSIONING' commission_ty_type, a.instruct_hdr_fid instruct_hdr_fid, a.instruct_amount  Commission_Amount, b.Transaction_type Transaction_type, b.instruct_amount transaction_amount, b.msisdn_key msisdn_key, ${DATE} tbl_dt from one a left join two b on b.instruct_hdr_fid=a.instruct_hdr_fid ) z )"
 q1=$(/opt/presto/bin/presto --server 10.1.197.145:8999 --catalog hive5 --schema flare_8 --execute "select count(*) from  flare_8.mfs_momo_agent_commission where tbl_dt = ${DATE}")
 q11=$(echo $q1 |  sed "s/\"//g")
 res=$(echo $q11)
 if [[ $res != 0 ]]
 then
  echo "Insertion finished for date: $DATE successfully"
 else
  echo "Couldn't Insert the data due to Presto issue or mismatching numbers, Please rerun me! "
  exit 1
 fi
else
 echo "The base table 'FIN_LOG' is empty!"
 exit 1
fi
