#!/bin/bash
date=$(date '+%Y%m%d')
old_date=$(date -d '-10 day' '+%Y%m%d')
/opt/presto/bin/presto --server master01004:8099 --catalog hive5 --schema flare_8 --execute "insert into  kpi_reports.network_kpi select cast(hour(date_parse(original_timestamp_enrich,'%Y-%m-%d %H:%i:%s')) as int) hour, case when traffictype = 'A2P' then 2 when traffictype = 'P2P' then 1 when traffictype = 'P2A' then 3 end as kpiType_id, (sum(cast(mt_success as double))/sum(cast( mt_total as double)))*100 measure_value, 4 as unit_id , case when traffictype = 'P2A' then 2 else 1 end as target_id, date_format(date_trunc('hour',current_timestamp), '%Y-%m-%d %H:%i:%s') current_datetime,tbl_dt from flare_8.smsc_a2p_p2p_p2a_a2a_success_rate where upper(traffictype) in ('P2A', 'A2P', 'P2P') and date_parse(date_format(from_unixtime(cast(kamanja_loaded_date as bigint)),'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d %H:%i:%s') between date_trunc('hour',(current_timestamp + interval '-1' hour)) and date_trunc('hour',current_timestamp) and tbl_dt between ${old_date} and ${date}  group by tbl_dt, cast(hour(date_parse(original_timestamp_enrich,'%Y-%m-%d %H:%i:%s')) as int), case when traffictype = 'A2P' then 2 when traffictype = 'P2P' then 1 when traffictype = 'P2A' then 3 end, case when traffictype = 'P2A' then 2 else 1 end" --output-format CSV
