#!/bin/bash
date=$(date '+%Y%m%d')
old_date=$(date -d '-10 day' '+%Y%m%d')
/opt/presto/bin/presto --server master01004:8099 --catalog hive5 --schema flare_8 --execute "insert into  kpi_reports.network_kpi select cast(hour(date_parse(original_timestamp_enrich,'%Y-%m-%d %H')) as int) hour , 4 as kpiType_id, sum(cast (SUCCESS_TIMES as double))/sum(cast (SUCCESS_TIMES as double) + cast (FAIL_TIMES as double)) * 100 measure_value, 4 as unit_id , 2 as target_id,  date_format(date_trunc('hour',current_timestamp), '%Y-%m-%d %H:%i:%s') current_datetime, tbl_dt from flare_8.ussd_traffic_success_rate where tbl_dt between ${old_date} and ${date} and date_parse(date_format(from_unixtime(cast(kamanja_loaded_date as bigint)),'%Y-%m-%d %H:%i:%s'),'%Y-%m-%d %H:%i:%s') between date_trunc('hour',(current_timestamp + interval '-1' hour)) and date_trunc('hour',current_timestamp) group by tbl_dt, cast(hour(date_parse(original_timestamp_enrich,'%Y-%m-%d %H')) as int)" --output-format CSV
