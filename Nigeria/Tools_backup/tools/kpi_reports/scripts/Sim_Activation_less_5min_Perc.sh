#!/bin/bash
date=$(date -d '-1 day' '+%Y%m%d')
old_date=$(date -d '-2 day' '+%Y%m%d')
/opt/presto/bin/presto --server master01004:8099 --catalog hive5 --schema flare_8 --execute "insert into  kpi_reports.network_kpi select cast(substr(UPDATE_DT_D,12,2) as int) hour , 18 as kpiType_id , (sum(case when date_diff('second',date_parse(substr(UPDATE_DT_D,1, length(UPDATE_DT_D) -6),'%Y-%m-%d %H:%i:%s.%f'),date_parse(substr(last_modified_date_d,1, length(last_modified_date_d) -6),'%Y-%m-%d %H:%i:%s.%f')) < 301 then 1 else 0 end)/cast (count(*) as double)) * 100 as measure_value, 4 as unit_id , 4 as target_id, cast(date_trunc('hour',date_parse(substr(UPDATE_DT_D,1, length(UPDATE_DT_D) -6),'%Y-%m-%d %H:%i:%s.%f')) as varchar) current_datetime, ${date} tbl_dt from flare_8.mso_process_avg_time where SERVICE_KEY_CODE_V IN ('SACT', 'SPKA') and tbl_dt = ${date} group by substr(UPDATE_DT_D,12,2), date_trunc('hour',date_parse(substr(UPDATE_DT_D,1, length(UPDATE_DT_D) -6),'%Y-%m-%d %H:%i:%s.%f'))" --output-format CSV
