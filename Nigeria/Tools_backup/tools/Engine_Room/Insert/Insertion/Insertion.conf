Insertion{
LoadCluster{
ClusterName=NigeriaLoadCluster
Schema="engine_room"

Feeds = [
 {
	feed="CELLS"
        base_feed="VP_DIM_CELLSITE"
	seq=1
	cols="coalesce(cdr_cgi,'') , coalesce(siteid,'') , coalesce(sitename,'') , coalesce(site_type,'') , coalesce(cluster,'') , coalesce(lon,'') , coalesce(lat,'')"
        cond=""
 }
 {
	feed="MFS_REGISTRATIONS"
        base_feed="flare_8.provisioning_log aa  left join nigeria.mfs_profile_categories bb on aa.profile_name = bb.profile_description"
        seq=3
	cols="date_format(from_iso8601_timestamp(original_timestamp_enrich ),'%Y%m%d%H%i%s')  date_key, agent_id  , rpt_category, to_hex(sha1(to_utf8((coalesce (agent_msisdn,'') )))) agent_msisdn, to_hex(sha1(to_utf8((coalesce (msisdn,'') )))) customer_msidn,registration_status,registration_end_date,kamanja_loaded_date, cast(date_format(from_iso8601_timestamp(original_timestamp_enrich ),'%Y%m%d') as int) tbl_dt" 
   	cond="and registration_date <> ''"
}
{
        feed="SIM_TRANSACTIONS" 
	base_feed="nigeria.daily_activation_base a left join ( select msisdn_key msisdn_key ,bts_mu_site_id FROM nigeria.geography"
         seq=4
         cols="(transaction_id ,date_key,sender_msisdn ,transaction_type ,receiver_msisdn, cell_id , distributor_id , stock_balance , kamanja_loaded_date , tbl_dt) select cast(a.tbl_dt as varchar) || to_hex(sha1(to_utf8(coalesce(cast(A.msisdn_key as varchar),'')))) TRANSACTION_ID ,cast(A.tbl_dt AS varchar) date_key ,'' sender_msisdn ,'sellout' transaction_type ,to_hex(sha1(to_utf8(coalesce(cast(A.msisdn_key as varchar),'')))) receiver_msisdn ,lo.bts_mu_site_id cell_id ,'' distributor_id ,'' stock_balance , cast(cast(to_unixtime(date_parse(cast(A.tbl_dt as varchar),'%Y%m%d')) as bigint) as varchar) kamanja_loaded_date ,A.tbl_dt tbl_dt"
	cond=""
}
{
	 feed="MFS_STOCK_LEVEL"
         base_feed="FINANCIAL_LOG"
         seq=5
         cols="z.original_timestamp_enrich, z.agentmsisdn, z.account_id,  z.wallet_type ,z.profile_category, z.EODBalance,z.kamanja_loaded_date, z.tbl_dt"
         cond="( select date_format(from_iso8601_timestamp(a.time_stamp ),'%Y%m%d%H%i%s') original_timestamp_enrich, cast(a.agentmsisdn as varchar) agentmsisdn, cast(account_id as varchar) account_id,  'main' wallet_type ,   lower(cc.rpt_category)  profile_category, b.instruct_from_bal_tot_aft EODBalance,     a.kamanja_loaded_date as kamanja_loaded_date, a.tbl_dt as tbl_dt, row_number() OVER (PARTITION BY  a.agentmsisdn  ORDER BY  a.time_stamp  desc ) rnk2 from agent_max_timestamp a left join agent_timestamp b on a.time_stamp=b.original_timestamp_enrich and a.agentmsisdn=b.msisdn_key and a.tbl_dt=b.tbl_dt left join nigeria.mfs_profile_categories cc on    (a.profile = cc.profile_description ) ) where  rnk2 = 1) z)"
}
 {
        feed="MFS_ACQUISITION"
        base_feed="EWP_ACCOUNT_HOLDERS_DUMP"
        seq=6
        cols="to_hex(md5(to_utf8((coalesce (msisdn,'') )))),    coalesce(id,0),    coalesce(external_id,''),    coalesce(firstname,''),    coalesce(middlename,''),    coalesce(surname,''),    coalesce(dateofbirth,''),    coalesce(gender,''),    coalesce(nationality,''),    coalesce(language,''),    coalesce(occupation,''),    coalesce(addressline1,''),    coalesce(addressline2,''),    coalesce(country,''),    coalesce(id_type,''),    coalesce(id_number,''),    coalesce(email,''),    coalesce(username,''),    coalesce(account_type,''),    coalesce(account_status,''),    coalesce(accountholder_status,''),    coalesce(blackliststatus,''),    coalesce(profile,''),    coalesce(bankdomain,''),    coalesce(employingcompany,''),    coalesce(lastactivitytime,''),    coalesce(registration_date,''),    coalesce(activation_date,''),    coalesce(blacklistdate,''),    coalesce(imsi,''),    coalesce(alias,''),    coalesce(parentaccountholder_id,''),    coalesce(parentaccountholder_msisdn,''),    coalesce(parentaccountholder_email,''),    coalesce(parentaccountholder_username,''),    coalesce(parentaccountholder_imsi,''),    coalesce(recruiter_id,''),    to_hex(md5(to_utf8((coalesce (recruiter_msisdn,'') )))),    coalesce(recruiter_email,''),    coalesce(recruiter_username,''),    coalesce(recruiter_imsi,''),    coalesce(file_name,''),    file_offset,    coalesce(kamanja_loaded_date,''),    coalesce(file_mod_date,''), to_hex(md5(to_utf8((cast(coalesce (msisdn_key,0) as varchar ))))),    date_key ,    event_timestamp_enrich,    coalesce(original_timestamp_enrich,''),    coalesce(msg_unique_id_enrich ,0),    coalesce(base_file_name,''),    coalesce(path,''),    line_number,    coalesce(file_id,''),    processed_timestamp,    ltz_event_timestamp_enrich"
 	cond=""
}
{
         feed="EVD_TRANSACTIONS"
         base_feed="ERS_VEND_NEW"
         seq=7
         cols="ersreference transaction_id , regexp_replace( original_timestamp_enrich, '[^0-9]+', '')   date , to_hex(sha1(to_utf8((coalesce (sendermsisdn,''))))) sender_msisdn , coalesce (receivermsisdn,'') receiver_msisdn , case when upper(senderjuridicalname) in ('MTN')  and transactiontype in ('TRANSFER')  and transactionprofile in ('IFS_TRANSFER')   then  'SELL_IN' when upper(senderjuridicalname) not in ('MTN')  and transactiontype in ('TRANSFER')  and transactionprofile not in ('IFS_TRANSFER')   then  'SELL_THROUGH' when  transactiontype in ('TOPUP') and upper(channel) in ('USSD')  then  'SELL_OUT' else 'OTHER' end transaction_type , receiveramountvalue transaction_amount , receivercellid  cell_id , senderjuridicalname distributor_id , senderbalancevaluebefore stock_balance,channel"
	cond="transaction_type not in ('OTHER')"
}
{
         feed="EVD_STOCK_LEVEL"
         base_feed="ERS_VEND_NEW"
         seq=8
         cols="to_hex(sha1(to_utf8(msisdn))) as msisdn,balancevalueafter,original_timestamp_enrich,kamanja_loaded_date,transaction_type,tbl_dt"
	 cond=""
}
{
         feed="CDR_DATA"
         base_feed="CS5_CCN_GPRS_MA"
         seq=9
         cols="to_hex(md5(to_utf8((cast(coalesce (msisdn_key,0) as varchar ))))),coalesce(original_timestamp_enrich ,''),coalesce(datavolumeincoming1 ,''),coalesce(datavolumeoutgoing1 ,''),coalesce(costofsession ,''),coalesce(normalizedchargedpartycgi_enrich ,''),coalesce(tac_enrich ,''),kamanja_loaded_date"
	 cond="and network_type_enrich=-1 and not (regexp_like("upper"(chargingcontextid),'SCAP') and length(trim(vascode))<>0)"
}
{
         feed="MFS_ACCOUNTS"
         base_feed="MFS_TRANSACTIONS"
         seq=10
         cols="select distinct date_key , account_type, accountid, msisdn, last_kamanja_loaded_date , tbl_dt from ( select cast( tbl_dt as varchar) date_key ,account_type, cast(accountid as varchar) accountid , msisdn ,max(kamanja_loaded_date) last_kamanja_loaded_date , tbl_dt from mfs_active_accounts group by cast( tbl_dt as varchar) ,cast(accountid as varchar) ,account_type, msisdn, tbl_dt )"
	cond="and to_profile_category <> ''"
}
{
         feed="CDR_RECHARGE"
         base_feed="CS5_AIR_REFILL_MA"
         seq=11
         cols="to_hex(md5(to_utf8((cast(coalesce (msisdn_key,0) as varchar ))))), original_timestamp_enrich ,case when trim(voucher_serial_nr) <> '' then 'physical recharge' else 'electronic recharge' end, coalesce(transactionamount,''), trim(replace(coalesce(cellglobalid,''),'-','')), (select coalesce(tac,'') from flare_8.dmc_dump_all  where flare_8.dmc_dump_all.msisdn_key = cs5_air_refill_ma.msisdn_key and flare_8.dmc_dump_all.tbl_dt=cs5_air_refill_ma.tbl_dt),kamanja_loaded_date"
	 cond=""
}
{
         feed="MFS_ACTIVE_SUBSCRIBERS"
         base_feed="EWP_ACCOUNT_HOLDERS_DUMP"
         seq=12
         cols="to_hex(md5(to_utf8((coalesce (msisdn,''))))),tbl_dt,case when account_status ='ACTIVE' then 'true' else 'false' end,kamanja_loaded_date"
	 cond=""
}
{
         feed="CDR_SUBSCRIPTION"
         base_feed="CS5_CCN_GPRS_MA"
         seq=13
         cols="to_hex(md5(to_utf8((cast(coalesce (msisdn_key,0) as varchar ))))),original_timestamp_enrich,vascode,costofsession,normalizedchargedpartycgi_enrich,(select coalesce(tac,'') from flare_8.dmc_dump_all  where flare_8.dmc_dump_all.msisdn_key = cs5_ccn_gprs_ma.msisdn_key and flare_8.dmc_dump_all.tbl_dt=cs5_ccn_gprs_ma.tbl_dt),kamanja_loaded_date"
	 cond="and regexp_like("upper"(chargingcontextid),'SCAP') and length(trim(vascode))<>0 and originatingservices in ('HWSDP','CIS')"
}
{
         feed="CDR_VOICE"
         base_feed="flare_8.cs5_ccn_voice_ma a LEFT JOIN flare_8.dmc_dump_all b ON ((a.chargepartynumber = b.msisdn) AND (a.tbl_dt = b.tbl_dt))"
         seq=14
         cols="to_hex(md5(to_utf8((coalesce (a.chargepartynumber,''))))), to_hex(md5(to_utf8((coalesce (a.calledcallingnumber,''))))) , a.original_timestamp_enrich , 'Outgoing' , (CASE WHEN (a.networkcd = '0') THEN 'International' WHEN (a.networkcd = '40') THEN 'Onnet' WHEN (a.networkcd = '79') THEN 'Onnet' ELSE 'Offnet' END) ,(CASE WHEN ((a.networkcd = '40') OR (a.networkcd = '79')) THEN 'MTN' ELSE null END) , (CASE WHEN (a.networkcd = '42') THEN 'glo' WHEN (a.networkcd = '41') THEN 'Airtel' WHEN (a.networkcd = '49') THEN 'Etisalat' WHEN (a.networkcd = '79') THEN 'Visafone/MTN' ELSE null END) , cast(a.call_duration as varchar), a.eventamount , replace(a.chargingpartyendcellid,'-','') , b.tac , a.kamanja_loaded_date"
 	 cond="to_hex(md5(to_utf8((cast(coalesce (b_number,0) as varchar ))))), to_hex(md5(to_utf8((coalesce (anum,''))))) , regexp_replace( original_timestamp_enrich, '[^0-9]+', '') , 'Incoming', case when bnum_operator='MTNN' and substr(regexp_replace(anum, '^00', ''),1,3) = '234' then 'Offnet'  when bnum_operator='MTNN' and substr(regexp_replace(anum, '^00', ''),1,3) <>'234' then 'International' end ,replace (bnum_operator,'MTNN','MTN') , anum_operator , cast(event_duration as varchar) , '' , '' ,tac ,kamanja_loaded_date, tbl_dt  from (select s.* , c.tac  from (select r.* from flare_8.wbs_pm_rated_cdrs r  left outer join nigeria.daily_sdp_dump_ma ma on (ma.tbl_dt = r.tbl_dt and ma.msisdn_key = r.msisdn_key)"

}
{
         feed="CDR_SMS"
         base_feed="vp_cs5_ccn_sms_ma_dasplit"
         seq=15
         cols="to_hex(md5(to_utf8((cast(coalesce (msisdn_key,0) as varchar ))))),to_hex(md5(to_utf8((coalesce (called_calling_number,''))))), original_timestamp_enrich,coalesce(call_type_desc,''), case when network_type_enrich_2 = 0 then 'Onnet' when network_type_enrich_2 = 1 then 'Offnet' when network_type_enrich_2 = 3 then 'International' else 'NA' end, 'MTN', case when network_type_enrich_2 = 0 then 'Visafone/MTN' when network_type_enrich_2=1 then offnet_operator else 'NA' end, cast(duration as varchar), cast(event_amount as varchar), coalesce(cgi,''), (select tac from flare_8.dmc_dump_all where vp_cs5_ccn_sms_ma_dasplit.tbl_dt=flare_8.dmc_dump_all.tbl_dt and vp_cs5_ccn_sms_ma_dasplit.msisdn_key =flare_8.dmc_dump_all.msisdn_key),kamanja_loaded_date"
	cond="and network_type_enrich_2<>2 and call_type_desc='outgoing'"
}
{
         feed="MSISDN_DISTRIBUTOR"
         base_feed="ERS_VEND_NEW"
         seq=16
         cols="distinct senderresellername as senderresellername,sendermsisdn,to_hex(sha1(to_utf8((coalesce (sendermsisdn,'') )))) hashed_sender_msisdn,case when upper(senderjuridicalname) in ('MTN') and transactiontype in ('TRANSFER') and transactionprofile in ('IFS_TRANSFER')  then 'SELL_IN' when upper(senderjuridicalname) not in ('MTN') and transactiontype in ('TRANSFER') and transactionprofile not in ('IFS_TRANSFER') then 'SELL_THROUGH' when transactiontype in ('TOPUP') then 'SELL_OUT' else 'OTHER' end as transaction_type"
	 cond="transaction_type in ('SELL_IN')"
}
{
         feed="POS_MSISDN"
         base_feed="MFS_TRANSACTIONS"
         seq=17
         cols="to_hex(sha1(to_utf8(pos_msisdn))) as msisdn_hash,pos_msisdn as msisdn,'mfs' as product_type,date_parse(date_format(now(),'%Y%m%d %H%i%s'),'%Y%m%d %H%i%s')  as update_datetime"
         cond="select distinct tbl_dt, profile_category, accountid, pos_msisdn from pos_accounts"
}
{
         feed="POS_GEO_PLACES"
         base_feed="MFS_TRANSACTIONS"
         seq=18
         cols="distinct to_hex(sha1(to_utf8(distinct(coalesce(mfs.pos_msisdn,''))))),coalesce(b.cluster,''),cast('' as varchar),cast('' as varchar),cast('' as varchar),cast('' as varchar),cast('' as varchar),cast('' as varchar),cast('' as varchar),date_parse(date_format(now(),'%Y%m%d %H%i%s'),'%Y%m%d %H%i%s'),mfs.tbl_dt"
         cond="select  distinct   tbl_dt , profile_category, accountid, pos_msisdn from pos_accounts"
}
{
         feed="PHYSICAL_RECHARGES"
         base_feed="NGVS_CDR NG"
         seq=19
 	 cols="ng.transactionid  transaction_id,date_format(date_parse(ng.original_timestamp_enrich ,'%d-%b-%y %H:%i:%s %p'),'%Y%m%d%H%i%s' )    date,'' sender_msisdn,to_hex(md5(to_utf8((cast(coalesce (ng.msisdn_key,0) as varchar ))))) receiver_msisdn, 'sell_out'  transaction_type, cast(try_CAST(ng.value  AS double)/100 as varchar)  value,cell_id, '' distributor_id, ''  stock_balance, kamanja_loaded_date, ng.tbl_dt"
         cond="on ng.tbl_dt = location.tbl_dt and ng.serialnumber =location.voucher_serial_nr and ng.msisdn_key = location.msisdn_key and ng.transactionid = location.origintransactionid where  upper(ng.state_card_state) = 'USED'"
}
{        feed="MFS_TRANSACTIONS"
         base_feed="transactions aa left join commissions bb on ( aa.tbl_dt = bb.tbl_dt and aa.instruct_hdr_fid=bb.instruct_hdr_fid ) left join nigeria.mfs_profile_categories cc on (aa.instruct_from_fro_user_prf = cc.profile_description ) left join nigeria.mfs_profile_categories dd on (aa.instruct_to_fro_user_prf = dd.profile_description ) left join ( select msisdn_key ,bts_mu_site_id FROM nigeria.geography"
         seq=20
         cols="aa.instruct_hdr_fid transaction_id, engine_tx_type transaction_type, date_time date_key, aa.msisdn_key sender_msisdn, aa.instruct_from_fro_id sender_account_id, aa.msisdn_key sender_wallet_id, instruct_from_fro_user_prf from_profile, lower(cc.rpt_category) from_profile_category, aa.instruct_from_bal_tot_aft sender_wallet_balance, aa.instruct_to_accnt_hldr_msisdn receiver_msisdn, aa.instruct_to_accnt_hldr_id receiver_account_id, aa.instruct_to_accnt_hldr_msisdn receiver_wallet_id, instruct_to_fro_user_prf to_profile, lower(dd.rpt_category) to_profile_category, aa.instruct_to_bal_tot_aft receiver_wallet_balance, aa.instruct_amount transaction_amount, bb.instruct_amount pos_commission_received_amount, bb.instruct_amount pos_commission_paid_amount, aa.instruct_to_ifee fee_received_amount, aa.instruct_from_ifee fee_paid_amount, loa.bts_mu_site_id sender_cell_id, lob.bts_mu_site_id receiver_cell_id, kamanja_loaded_date, aa.tbl_dt"
	 cond="and aggr ='daily' AND msisdn_key <> 0) lob on ( aa.instruct_to_accnt_hldr_msisdn = lob.msisdn_key)"
}
{         feed="BUNDLE_SPLIT"
         base_feed="(select bundle_id,bundle_name,type,service_id from ( select bundle_id,bundle_name,type,service_id,row_number() over (partition by bundle_id order by case when type='VAS' then 0 when type='VOICE' then 1 when type='SMS' then 2 when type='DATA' then 3 when type='COMBO' then 4 else 5 end) as rnk from ( select productid as bundle_id, productname as bundle_name, case when upper(trim(category)) in ('DATA2SHARE','SOCIAL BUNDLE','DIGITAL EBU DATA BUNDLE','EXTRAVALUE DATA','DATA BUNDLE','GOODYBAG DATA','SME BUNDLE') then 'DATA' when length(upper(trim(category)))=0 then 'OTHERS' else upper(trim(category)) end as type, servcieid as service_id from nigeria.vp_enterprise_catalogue where coalesce(try_cast(trim(productid) as bigint),-1)<>-1 union select product_id as bundle_id, product_name as bundle_name, case when upper(trim(product_category)) in ('DATA2SHARE','SOCIAL BUNDLE','DIGITAL EBU DATA BUNDLE','EXTRAVALUE DATA','DATA BUNDLE','GOODYBAG DATA','SME BUNDLE') then 'DATA' when length(upper(trim(product_category)))=0 then 'OTHERS' else upper(trim(product_category)) end as type, service_id from flare_8.vp_hsdp_lookup_new where coalesce(try_cast(trim(product_id) as bigint),-1)<>-1 union select product_id as bundle_id, product_name as bundle_name, case when upper(trim(type)) in ('DATA2SHARE','SOCIAL BUNDLE','DIGITAL EBU DATA BUNDLE','EXTRAVALUE DATA','DATA BUNDLE','GOODYBAG DATA','SME BUNDLE') then 'DATA' when length(upper(trim(type)))=0 then 'OTHERS' else upper(trim(type)) end as type, '' as service_id from nigeria.cis_catalogue"
         seq=21
         cols="(bundle_name,bundle_id,is_in_splitproduct,type,service_id,voice_split,sms_split,data_split,vas_split,other_split,update_datetime,tbl_dt) select cis.bundle_name,cis.bundle_id,case when length(cast(split.product_id as varchar))>0 then 1 else 0 end as is_in_splitproduct,cis.type,cis.service_id,cast(case when length(cast(split.product_id as varchar))>0 then 1-split.rate when upper(trim(cis.type))='VOICE' then 1.0 else 0.0 end as double) as voice_split,cast(case when upper(trim(cis.type))='SMS' then 100 else 0 end as double) as sms_split,cast(case when length(cast(split.product_id as varchar))>0 then split.rate when upper(trim(cis.type)) in ('DATA') then 1.0 else 0.0 end as double) as data_split,cast(case when upper(trim(cis.type))='VAS' then 1.0 else 0.0 end as double) as vas_split,cast(case when upper(trim(cis.type)) not in ('VOICE','SMS','DATA','VAS') then 1.0 else 0.0 end as double) as other_split,date_parse(date_format(now(),'%Y%m%d %H%i%s'),'%Y%m%d %H%i%s') as update_datetime"
         cond="and length(product_id)>0 and coalesce(try_cast(trim(product_id) as bigint),-1)<>-1)) where rnk=1) cis"
}
 ]
 }
}
 
 
